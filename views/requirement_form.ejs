<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Requirement Form</title>
  <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .form-control[readonly] {
      background-color: #e9ecef;
      opacity: 1;
    }
  </style>
</head>
<body>
  <div class="container mt-5">
    <h3>Requirement Form</h3>
    <form id="menuForm" onsubmit="handleSubmit(event)">
      <table class="table table-bordered" id="menuTable">
        <thead>
          <tr>
            <th>SN</th>
            <th>Menu Item Code</th>
            <th>Menu Item Description</th>
            <th>Quantity</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>1</td>
            <td><input type="text" class="form-control" name="menuItemCode[]" onchange="fetchDescription(this)"></td>
            <td><input type="text" class="form-control" name="menuItemDescription[]"></td>
            <td><input type="number" class="form-control" name="quantity[]"></td>
            <td><button type="button" class="btn btn-danger" onclick="deleteRow(this)">Delete</button></td>
          </tr>
        </tbody>
      </table>
      <button type="button" class="btn btn-secondary" onclick="addRow()">Add Row</button>
      <button type="submit" class="btn btn-primary">Submit</button>
    </form>
    <div id="resultContainer" class="mt-4"></div>
  </div>

  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
  <script>
    function addRow() {
      const table = document.getElementById("menuTable").getElementsByTagName('tbody')[0];
      const rowCount = table.rows.length;
      const row = table.insertRow(rowCount);

      const cell1 = row.insertCell(0);
      const cell2 = row.insertCell(1);
      const cell3 = row.insertCell(2);
      const cell4 = row.insertCell(3);
      const cell5 = row.insertCell(4);

      cell1.innerHTML = rowCount + 1;
      cell2.innerHTML = `<input type="text" class="form-control" name="menuItemCode[]" onchange="fetchDescription(this)">`;
      cell3.innerHTML = `<input type="text" class="form-control" name="menuItemDescription[]">`;
      cell4.innerHTML = `<input type="number" class="form-control" name="quantity[]">`;
      cell5.innerHTML = `<button type="button" class="btn btn-danger" onclick="deleteRow(this)">Delete</button>`;
    }

    function deleteRow(button) {
      const row = button.closest('tr');
      row.remove();
      updateSN();
    }

    function updateSN() {
      const table = document.getElementById("menuTable").getElementsByTagName('tbody')[0];
      for (let i = 0; i < table.rows.length; i++) {
        table.rows[i].cells[0].innerHTML = i + 1;
      }
    }

    function handleSubmit(event) {
      event.preventDefault();

      const form = document.getElementById('menuForm');
      const formData = new FormData(form);
      const data = {};

      formData.forEach((value, key) => {
        if (!data[key]) {
          data[key] = [];
        }
        data[key].push(value);
      });

      console.log('Form Data:', data);

      fetch('/calculate-requirements', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
      })
      .then(response => response.json())
      .then(result => {
        console.log('Server Response:', result);
        displayResults(result);
      });
    }

    function displayResults(results) {
      const resultContainer = document.getElementById('resultContainer');
      resultContainer.innerHTML = '';

      results.forEach((result, index) => {
        const div = document.createElement('div');
        div.innerHTML = `
          <h4>Result ${index + 1}</h4>
          <p>Menu Item Code: ${result.menu_item_code}</p>
          <p>Item Code: ${result.item_code}</p>
          <p>Ingredient Description: ${result.ingredient_description}</p>
          <p>Ingredient UOM: ${result.ingredient_uom}</p>
          <p>Ingredient Quantity: ${result.total_ingredient_qty}</p>
          <p>Rate: ${result.rate}</p>
          <p>Total Cost: ${result.total_cost}</p>
        `;
        resultContainer.appendChild(div);
      });
    }

    function fetchDescription(input) {
      const menuItemCode = input.value;
      const url = `/fetch-menu-item-description?menuItemCode=${menuItemCode}`;
      $.get(url, function(data) {
        const descriptionInput = input.closest('tr').querySelector('input[name="menuItemDescription[]"]');
        descriptionInput.value = data.description;
      });
    }
  </script>
</body>
</html>
